# Phase C Web Status UI Workflow
# Walking skeleton: setup_git → validate_git → Piece 1–3 (each: code_review → ai_uat; fail → bug report → piece_N)
# Per-piece gates: AI code review + AI UAT (agent-browser). No user UAT per piece. Final HITL only.
# Run: Execute workflows/phase-c-web-status-ui-workflow.yaml
# PRD: docs/sprints/PHASE-C-PRD.md
#
# Git (canonical): branch=feature/phase-c-web-status-ui, worktree=../workflow-engine-phase-c (optional)

workflow:
  name: "Phase C Web Status UI Workflow"
  version: "1.0"

  roles:
    developer:
      mode: "agent"
      description: "Implements web-status-ui pieces"
    reviewer:
      mode: "plan"
      description: "Reviews code against PRD"
    validator:
      mode: "agent"
      description: "Validates git context, runs code quality, AI UAT via agent-browser"

  tasks:
    # Piece 0: setup_git — Create branch/worktree
    - id: "setup_git"
      name: "Setup Git (create branch/worktree)"
      role: "developer"
      action: "implement"
      params:
        deliverable: "Run scripts/setup_git.sh (or setup_git.ps1 on Windows)"
        validation: "Branch feature/phase-c-web-status-ui exists and is checked out"
      hitl:
        type: "none"
      on_complete: "validate_git"

    # Piece 0: validate_git — Verify context
    - id: "validate_git"
      name: "Validate Git (branch/worktree)"
      role: "validator"
      action: "implement"
      params:
        deliverable: "Run scripts/validate_git.sh (or validate_git.ps1 on Windows)"
        validation: "Script exits 0; we are on feature/phase-c-web-status-ui"
      hitl:
        type: "none"
      on_complete: "piece_1"

    # Piece 1: Minimal server + WAITING_ON
    - id: "piece_1"
      name: "Piece 1: Minimal server + read WAITING_ON"
      role: "developer"
      action: "implement"
      params:
        prd_path: "docs/sprints/PHASE-C-PRD.md"
        piece: 1
        deliverable: "web-status-ui/ with Node server, reads memory/projects/<project>/WAITING_ON.md"
        validation: "npm run start in web-status-ui, browser shows WAITING_ON content"
      hitl:
        type: "none"
      on_complete: "piece_1_code_review"

    - id: "piece_1_code_review"
      name: "Piece 1: Code review"
      role: "reviewer"
      action: "review"
      params:
        file: "web-status-ui/server.js"
        criteria: "PRD compliance, port fallback (3456-3458), no obvious bugs"
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "piece_1_ai_uat"
        - if: "result == 'fail'"
          then: "piece_1"
      on_complete: "piece_1_ai_uat"

    - id: "piece_1_ai_uat"
      name: "Piece 1: AI UAT (agent-browser)"
      role: "validator"
      action: "implement"
      params:
        deliverable: "Start server, use agent-browser to navigate to http://localhost:PORT, verify WAITING_ON content in page"
        validation: "AI confirms UI displays WAITING_ON. Kill server after verification."
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "piece_2"
        - if: "result == 'fail'"
          then: "piece_1"
      on_complete: "piece_2"

    # Piece 2: workflow-state.json + execution-log
    - id: "piece_2"
      name: "Piece 2: workflow-state.json + execution-log"
      role: "developer"
      action: "implement"
      params:
        prd_path: "docs/sprints/PHASE-C-PRD.md"
        piece: 2
        deliverable: "Extend UI: read workflow-state.json, execution-log.md; show paused state, last run"
        validation: "UI shows paused workflow or last run status when files exist"
      hitl:
        type: "none"
      on_complete: "piece_2_code_review"

    - id: "piece_2_code_review"
      name: "Piece 2: Code review"
      role: "reviewer"
      action: "review"
      params:
        file: "web-status-ui/"
        criteria: "PRD compliance, workflow-state and execution-log parsing"
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "piece_2_ai_uat"
        - if: "result == 'fail'"
          then: "piece_2"
      on_complete: "piece_2_ai_uat"

    - id: "piece_2_ai_uat"
      name: "Piece 2: AI UAT (agent-browser)"
      role: "validator"
      action: "implement"
      params:
        deliverable: "Start server, use agent-browser to verify workflow-state and execution-log displayed"
        validation: "AI confirms UI shows paused state and last run when files exist"
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "piece_3"
        - if: "result == 'fail'"
          then: "piece_2"
      on_complete: "piece_3"

    # Piece 3: Project list + pending gates
    - id: "piece_3"
      name: "Piece 3: Project list + pending gates"
      role: "developer"
      action: "implement"
      params:
        prd_path: "docs/sprints/PHASE-C-PRD.md"
        piece: 3
        deliverable: "Scan memory/projects/*; list projects; show pending gates per project"
        validation: "UI lists projects, shows which have paused workflows"
      hitl:
        type: "none"
      on_complete: "piece_3_code_review"

    - id: "piece_3_code_review"
      name: "Piece 3: Code review"
      role: "reviewer"
      action: "review"
      params:
        file: "web-status-ui/"
        criteria: "PRD compliance, project scan, pending gates display"
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "piece_3_ai_uat"
        - if: "result == 'fail'"
          then: "piece_3"
      on_complete: "piece_3_ai_uat"

    - id: "piece_3_ai_uat"
      name: "Piece 3: AI UAT (agent-browser)"
      role: "validator"
      action: "implement"
      params:
        deliverable: "Start server, use agent-browser to verify project list and pending gates"
        validation: "AI confirms UI lists projects and shows pending gates"
      hitl:
        type: "none"
      conditions:
        - if: "result == 'pass'"
          then: "uat_final"
        - if: "result == 'fail'"
          then: "piece_3"
      on_complete: "uat_final"

    # Final: User UAT
    - id: "uat_final"
      name: "User UAT (Final)"
      role: "validator"
      action: "complete"
      hitl:
        type: "approval"
        message: "Phase C UAT complete. Approve to allow push to main. No push until you approve."
      on_complete: "end"
